<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<!-- <!doctype html public "-//W3C//DTD HTML 3.2//EN"> -->
<html>
  <head>
    <title>landialler: Packet Filtering Scripts</title>
  </head>

  <body bgcolor="#ffffff">
    <blockquote>

      <center>
	<font size="-1">
	  [&nbsp;<a href="./">back</a>&nbsp;]
	</font>
      </center>

      <p>
	These are the scripts that I use to run my iptables commands
	on a Linux 2.4 kernel. I prefer the Debian distribution, which
	very cleverly lets you drop scripts in the
	<kbd>/etc/ppp/ip-up.d</kbd> directory to have them
	automatically run when dialling up.
      </p>

      <h2>packet-filter-up</h2>

      These commands are copied almost verbatim out of the relevant
      HOWTOs. If you have configured your kernel so that all the
      iptables functionality is compiled directly into the kernel
      (rather than as modules) then you should comment out the lines
      that begin with <kbd>modprobe</kbd> command.

      <pre>
#!/bin/sh
#
# $Id$
#
# Home firewall script, put together from commands in the NAT and
# packet filtering HOWTO documents.
#
# Suitable for dropping into /etc/ppp/ip-up.d if you're running
# Debian, to be automatically run by /usr/bin/pon after dial up.

# Load the NAT module (this pulls in all the others).
modprobe iptable_nat
# insmod ip_conntrack (autoloaded by iptable_nat by the looks of it)
insmod ip_conntrack_ftp

# Clear all current rules, so we start from a clean slate.
iptables -F

# Create chain which blocks new connections, except if coming from inside.
iptables -N block
iptables -A block -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A block -m state --state NEW -i ! ppp0 -j ACCEPT
iptables -A block -j DROP

# Jump to that chain from INPUT and FORWARD chains.
iptables -A INPUT -j block
iptables -A FORWARD -j block

# In the NAT table (-t nat), Append a rule (-A) after routing
# (POSTROUTING) for all packets going out ppp0 (-o ppp0) which says to
# MASQUERADE the connection (-j MASQUERADE).
iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE

# Turn on IP forwarding
echo 1 > /proc/sys/net/ipv4/ip_forward
      </pre>

      <h2>packet-filter-down</h2>

      This script cleans up when the dial up connection is closed
      down. I really ought to make it unload the kernel modules loaded
      by the <kbd>packet-filter-up</kbd> script...

      <pre>
#!/bin/sh
#
# $Id$
#
# Home firewall stop script.
#
# Suitable for dropping into /etc/ppp/ip-down.d if you're running
# Debian, to be automatically run by /usr/bin/pon after dial up.

# Turn off IP forwarding
echo 0 > /proc/sys/net/ipv4/ip_forward
      </pre>

      <center>
	<font size="-1">
	  [&nbsp;<a href="./">back</a>&nbsp;]
	</font>
      </center>

      <hr size="1">
      <table border="0" cellpadding="0" cellspacing="0" width="100%">
	<tbody>
	  <tr>
	    <td align="left" valign="top">
	      <font size="-1">
		&copy; 2001, Graham Ashton &lt;ashtong@users.sourceforge.net&gt;
	      </font>
	    </td>
	    <td align="right">
	      <a href="http://sourceforge.net/"><img
                 src="http://sourceforge.net/sflogo.php?group_id=34228"
		 width="88" height="31" border="0" alt="SourceForge logo"></a>
	    </td>
	  </tr>
	</tbody>
      </table>

    </blockquote>
  </body>
</html>
